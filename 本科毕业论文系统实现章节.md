# 系统实现章节

## 1. 系统整体架构与模块划分
本系统基于区块链技术，采用智能合约实现宠物管理的核心业务逻辑。系统主要分为三大核心合约模块：机构管理（InstitutionManager）、用户管理（UserManager）、宠物管理（PetManager），并配套前端与合约的集成实现。各模块通过合约地址进行关联，确保数据一致性和权限安全。

## 2. 智能合约实现细节
### 2.1 机构管理合约（InstitutionManager）
- **核心功能**：实现医院/救助站等机构的注册、信息更新、员工管理、负责人变更等。
- **关键数据结构**：
  - `Institution[] public institutions`：机构信息数组。
  - `mapping(address => uint) public staffToInstitution`：员工地址到机构ID的映射。
  - `uint256 public institutionIdCounter`：机构ID自增计数器。
- **主要方法**：
  - `addInstitution`：仅部署者可调用，注册新机构并自动将负责人加入员工列表。
  - `updateInstitution`：负责人或部署者可更新机构信息。
  - `addStaffToInstitution`/`removeStaffFromInstitution`：负责人可管理机构员工。
  - `getInstitutionDetail`/`getAllInstitutions`：查询机构详细信息及列表。
- **测试覆盖**：
  - 验证部署者权限、机构ID自增、负责人唯一性、不同类型机构注册、员工管理等。

### 2.2 用户管理合约（UserManager）
- **核心功能**：实现用户注册、资料管理、角色分配、宠物所有权记录。
- **关键数据结构**：
  - `mapping(address => uint) public userIds`：用户地址到用户ID映射。
  - `User[] public users`：用户信息数组。
  - `uint256 public userIdCounter`：用户ID自增计数器。
- **主要方法**：
  - `setUserProfile`：支持个人/机构用户注册，自动分配角色（普通用户、医院、救助站、管理员）。
  - `getUserInfo`：查询用户详细资料。
  - `addPetToUser`：为用户添加宠物ID。
- **权限与关联**：
  - 机构用户注册需先被添加为机构员工。
  - 角色分配依据用户类型和机构类型自动判定。
- **测试覆盖**：
  - 个人/机构用户注册、资料设置、机构关联、角色分配、用户信息查询等。

### 2.3 宠物管理合约（PetManager）
- **核心功能**：实现宠物信息登记、更新、健康与领养状态管理、领养/医疗/救助事件记录。
- **关键数据结构**：
  - `Pet[] public pets`：宠物信息数组。
  - `mapping(address => mapping(uint => bool)) private userPets`：用户与宠物ID的映射。
  - `AdoptionEvent[] public adoptionEvents`、`MedicalEvent[] public medicalEvents`、`RescueRequest[] public rescueRequests`：事件记录。
- **主要方法**：
  - `addPet`/`updatePet`：登记和更新宠物信息，自动与用户关联。
  - `adoptPet`/`recordMedicalEvent`/`submitRescueRequest`：实现领养、医疗、救助等业务流程。
  - `getPetDetail`/`getAllPets`：查询宠物信息。
- **合约交互**：
  - 通过UserManager校验用户注册状态、更新用户宠物列表。
  - 通过InstitutionManager校验机构信息。
- **测试覆盖**：
  - 宠物登记、信息更新、事件记录、用户与宠物关联、权限校验等。

## 3. 合约测试与业务流程验证
- **测试用例**严格覆盖了合约的部署、权限控制、数据一致性、业务流程（如机构注册、用户注册、宠物登记、领养、医疗、救助等）。
- 通过模拟不同角色（部署者、机构负责人、普通用户）操作，确保合约逻辑与权限设计的正确性。
- 典型流程如：
  - 部署合约，注册机构，添加员工，注册用户，登记宠物，发起领养/医疗/救助事件。

## 4. 前端与合约集成实现要点
- 前端通过ethers.js与合约ABI和地址进行交互，调用合约方法实现注册、信息查询、事件提交等功能。
- 合约地址和ABI集中配置于`src/config/contracts.ts`，便于前端统一管理和升级。
- 采用事件监听与状态刷新机制，确保前端数据与区块链状态实时同步。

## 5. 技术创新与实现亮点
- 采用多合约分层设计，职责清晰，便于扩展和维护。
- 权限与角色自动判定，提升系统安全性和易用性。
- 业务流程全链上实现，数据公开透明、不可篡改。
- 测试用例全面覆盖，保障系统稳定性和可靠性。

## 6. 小结
本系统通过智能合约实现了宠物管理的核心业务流程，前后端协同保证了数据的安全与一致性。所有实现细节均严格依据实际代码，确保论文内容与系统开发完全一致。